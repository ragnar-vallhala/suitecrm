<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EspoCRM Backup Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 600px; max-width: 100%; }
        h1 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; color: #666; }
        input { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background: #0056b3; }
        #dashboard { display: none; }
        .backup-list { list-style: none; padding: 0; margin-top: 2rem; max-height: 300px; overflow-y: auto; }
        .backup-item { background: #f9f9f9; padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .actions button { width: auto; font-size: 0.8rem; margin-left: 0.5rem; padding: 0.4rem 0.8rem; }
        .btn-restore { background: #dc3545; }
        .btn-restore:hover { background: #a71d2a; }
        .btn-download { background: #28a745; }
        .btn-download:hover { background: #1e7e34; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .logout { color: #666; text-decoration: none; font-size: 0.9rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="container" id="login-screen">
    <h1>Login</h1>
    <p>Use your EspoCRM credentials.</p>
    <div class="form-group">
        <label>Username</label>
        <input type="text" id="username">
    </div>
    <div class="form-group">
        <label>Password</label>
        <input type="password" id="password">
    </div>
    <button onclick="login()">Login</button>
</div>

<div class="container" id="dashboard">
    <div class="header">
        <h1>Backups</h1>
        <a class="logout" onclick="logout()">Logout</a>
    </div>
    
    <button onclick="triggerBackup()">Backup Now</button>
    
    <ul class="backup-list" id="backup-list">
        <!-- Backups will load here -->
    </ul>
</div>

<script>
    let creds = null;

    async function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const c = btoa(u + ':' + p);
        
        try {
            const res = await fetch('api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            const data = await res.json();
            
            if (data.success) {
                creds = c;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadBackups();
            } else {
                alert('Login failed');
            }
        } catch (e) {
            alert('Error logging in');
        }
    }
    
    function logout() {
        creds = null;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('login-screen').style.display = 'block';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    async function loadBackups() {
        const res = await fetch('api/backups', {
            headers: { 'Authorization': 'Basic ' + creds }
        });
        const backups = await res.json();
        
        const list = document.getElementById('backup-list');
        list.innerHTML = '';
        
        backups.forEach(b => {
            const li = document.createElement('li');
            li.className = 'backup-item';
            
            // Format timestamp nicely
            const year = b.timestamp.substring(0,4);
            const month = b.timestamp.substring(4,6);
            const day = b.timestamp.substring(6,8);
            const hour = b.timestamp.substring(8,10);
            const min = b.timestamp.substring(10,12);
            const sec = b.timestamp.substring(12,14);
            const dateStr = `${year}-${month}-${day} ${hour}:${min}:${sec}`;

            let html = `<span>${dateStr}</span> <div class="actions">`;
            
            // Files download links
            b.files.forEach(f => {
                const type = f.endsWith('.sql') ? 'DB' : 'Data';
                // We use a small fetch trick or just direct link. 
                // Since direct link needs browser auth prompt, let's try opening in new tab 
                // and letting browser handle the 401 challenge if we can't pass header easily in navigation.
                // However, user already has credentials. We can construct a URL with embedded creds? NO.
                // We will rely on the "Basic Auth" browser prompt or just XHR blob download.
                // Let's do XHR blob download for better UX.
                html += `<button class="btn-download" onclick="downloadFile('${f}')">${type}</button>`;
            });

            html += `<button class="btn-restore" onclick="restore('${b.timestamp}')">Restore</button>`;
            html += `</div>`;
            li.innerHTML = html;
            list.appendChild(li);
        });
    }

    async function triggerBackup() {
        if(!confirm('Create a new backup now?')) return;
        const res = await fetch('api/trigger-backup', {
            method: 'POST',
            headers: { 'Authorization': 'Basic ' + creds }
        });
        if (res.ok) {
            alert('Backup started!');
            setTimeout(loadBackups, 2000);
        } else {
            alert('Failed to start backup');
        }
    }

    async function restore(timestamp) {
        if(!confirm('WARNING: This will overwrite data. EspoCRM will be restarted. Continue?')) return;
        
        const res = await fetch('api/restore', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + creds 
            },
            body: JSON.stringify({ timestamp })
        });
        
        if (res.ok) {
            alert('Restore started successfully. The system will be briefly unavailable.');
        } else {
            alert('Restore failed to start.');
        }
    }
    
    async function downloadFile(filename) {
         // Using fetch to get blob and trigger download, sending the auth header
         try {
             const response = await fetch(`api/download/${filename}`, {
                 headers: { 'Authorization': 'Basic ' + creds }
             });
             if (!response.ok) throw new Error('Download failed');
             
             const blob = await response.blob();
             const url = window.URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = filename;
             document.body.appendChild(a);
             a.click();
             window.URL.revokeObjectURL(url);
             a.remove();
         } catch(e) {
             alert('Error downloading file: ' + e.message);
         }
    }
</script>

</body>
</html>
